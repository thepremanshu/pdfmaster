<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APNA ADDA - Premium PDF Tools</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- PDF Libraries (Versions fixed for compatibility) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background: #0f172a; color: white; overflow-x: hidden; }

        /* UI Styles */
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-header { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .gradient-text { background: linear-gradient(to right, #60a5fa, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Viewer & Canvas */
        #workspace-area {
            position: relative; margin: 0 auto; 
            padding: 40px 0; display: flex; justify-content: center; 
            background: #334155; 
            overflow: auto;
            min-height: 80vh;
        }

        #pdf-wrapper { position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        #the-canvas { display: block; }

        /* Edit Layers */
        #draw-layer { position: absolute; top: 0; left: 0; z-index: 10; touch-action: none; pointer-events: none; }
        #text-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; overflow: hidden; }

        .draggable-text {
            position: absolute; border: 1px dashed transparent; padding: 4px;
            pointer-events: auto; white-space: nowrap; user-select: none; font-family: 'Helvetica', sans-serif; line-height: 1;
        }
        .draggable-text:hover { border-color: #3b82f6; background: rgba(255,255,255,0.2); cursor: move; }
        
        /* Deletion X button */
        .del-btn {
            position: absolute; top: -10px; right: -10px; width: 20px; height: 20px;
            background: red; color: white; border-radius: 50%; font-size: 12px;
            display: none; align-items: center; justify-content: center; cursor: pointer;
        }
        .draggable-text:hover .del-btn { display: flex; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .progress-bar { width: 200px; height: 4px; background: #334155; border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2563eb, #9333ea); width: 0%; animation: load 2s ease-in-out forwards; }
        @keyframes load { to { width: 100%; } }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="loader">
        <h1 class="text-3xl font-bold tracking-widest text-white">APNA ADDA</h1>
        <div class="progress-bar"><div class="progress-fill"></div></div>
        <p class="mt-4 text-gray-500 text-xs">DEVELOPED BY PREMANSHU KUMAR</p>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur">
        <div class="glass p-8 rounded-2xl w-full max-w-sm relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-2 text-center">Log In Required</h2>
            <p class="text-gray-400 text-xs text-center mb-6">Login to Download/Save files</p>
            <form id="login-form" class="space-y-4">
                <input type="email" id="u-email" placeholder="Email" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white outline-none focus:border-blue-500" required>
                <input type="password" id="u-pass" placeholder="Password" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white outline-none focus:border-blue-500" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold text-white transition">Enter Apna Adda</button>
            </form>
            <p id="login-error" class="text-red-500 text-xs text-center mt-3"></p>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app" class="hidden flex flex-col min-h-screen">
        
        <!-- NAVBAR -->
        <header class="glass-header fixed w-full z-40 h-16 flex items-center">
            <div class="w-full max-w-7xl mx-auto px-4 flex justify-between items-center">
                <div class="text-xl font-bold gradient-text cursor-pointer" onclick="goHome()">APNA ADDA</div>
                <div class="flex items-center gap-4">
                    <span id="u-name" class="text-sm text-blue-300 font-medium hidden"></span>
                    <button id="auth-btn" onclick="openModal()" class="bg-slate-700 hover:bg-slate-600 text-white text-xs px-4 py-2 rounded-full font-bold">LOGIN</button>
                </div>
            </div>
        </header>

        <!-- MAIN -->
        <main class="flex-grow pt-16">

            <!-- VIEW: HOME -->
            <section id="home-view" class="max-w-7xl mx-auto px-4 py-20 fade-in">
                <div class="text-center mb-16">
                    <h1 class="text-5xl font-bold mb-6">PDF Tools <span class="gradient-text">Reimagined</span></h1>
                    <p class="text-gray-400 max-w-2xl mx-auto">The easiest way to View, Edit, Protect and Unlock PDF files.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-5xl mx-auto">
                    <!-- Cards -->
                    <div onclick="selectTool('view')" class="glass p-8 rounded-xl cursor-pointer hover:bg-white/5 transition group">
                        <i class="fas fa-eye text-4xl text-blue-500 mb-4 group-hover:scale-110 transition"></i>
                        <h3 class="font-bold text-lg">View PDF</h3>
                    </div>
                    <div onclick="selectTool('edit')" class="glass p-8 rounded-xl cursor-pointer hover:bg-white/5 transition group">
                        <i class="fas fa-pen-nib text-4xl text-green-500 mb-4 group-hover:scale-110 transition"></i>
                        <h3 class="font-bold text-lg">Edit PDF</h3>
                    </div>
                    <div onclick="selectTool('protect')" class="glass p-8 rounded-xl cursor-pointer hover:bg-white/5 transition group">
                        <i class="fas fa-lock text-4xl text-red-500 mb-4 group-hover:scale-110 transition"></i>
                        <h3 class="font-bold text-lg">Protect PDF</h3>
                    </div>
                    <div onclick="selectTool('unlock')" class="glass p-8 rounded-xl cursor-pointer hover:bg-white/5 transition group">
                        <i class="fas fa-unlock text-4xl text-yellow-500 mb-4 group-hover:scale-110 transition"></i>
                        <h3 class="font-bold text-lg">Unlock PDF</h3>
                    </div>
                </div>
            </section>

            <!-- VIEW: WORKSPACE -->
            <section id="work-view" class="hidden w-full h-full flex flex-col">
                
                <!-- Toolbar -->
                <div class="bg-slate-800 border-b border-slate-700 p-2 flex items-center justify-between shadow-lg sticky top-16 z-30">
                    <button onclick="goHome()" class="text-gray-400 hover:text-white px-3"><i class="fas fa-arrow-left"></i></button>
                    
                    <h2 id="tool-title" class="text-sm font-bold text-blue-400 uppercase tracking-wider">Tool Name</h2>

                    <!-- Conditional Tool Controls -->
                    <div id="controls-edit" class="hidden flex items-center gap-2">
                        <button onclick="setMode('pen')" id="btn-pen" class="p-1.5 rounded hover:bg-slate-700 text-gray-400"><i class="fas fa-pencil"></i></button>
                        <input type="color" id="pen-color" value="#ff0000" class="w-6 h-6 bg-transparent border-0 cursor-pointer">
                        <button onclick="setMode('text')" id="btn-text" class="p-1.5 rounded hover:bg-slate-700 text-gray-400"><i class="fas fa-font"></i></button>
                        <button onclick="clearCurrentEdits()" class="p-1.5 text-xs text-red-400 ml-2 hover:bg-slate-700">Clear</button>
                    </div>

                    <div id="controls-protect" class="hidden flex items-center gap-2">
                        <input type="password" id="protect-pwd" placeholder="Set Password" class="bg-slate-700 text-white text-xs px-2 py-1 rounded w-32 outline-none">
                    </div>
                    
                    <div id="controls-nav" class="flex items-center gap-2">
                        <button onclick="changePage(-1)" class="w-8 h-8 flex items-center justify-center bg-slate-700 rounded hover:bg-slate-600"><i class="fas fa-chevron-left"></i></button>
                        <span id="pg-num" class="text-xs font-mono w-10 text-center">0/0</span>
                        <button onclick="changePage(1)" class="w-8 h-8 flex items-center justify-center bg-slate-700 rounded hover:bg-slate-600"><i class="fas fa-chevron-right"></i></button>
                        <button onclick="triggerDownload()" class="ml-4 bg-blue-600 hover:bg-blue-500 text-white text-xs px-4 py-2 rounded font-bold shadow-lg transition">Download</button>
                    </div>
                </div>

                <!-- Step 1: Upload / Password Prompt -->
                <div id="step-upload" class="flex-grow flex items-center justify-center py-20">
                    
                    <!-- Uploader -->
                    <div id="drop-zone" onclick="document.getElementById('file-in').click()" class="border-2 border-dashed border-slate-600 bg-slate-800/50 p-16 rounded-2xl cursor-pointer hover:border-blue-500 hover:bg-slate-800 transition text-center">
                        <input type="file" id="file-in" class="hidden" accept="application/pdf">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-500 mb-4"></i>
                        <p class="font-bold text-gray-300">Click to Upload PDF</p>
                    </div>

                    <!-- Password Prompt for Locked Files -->
                    <div id="lock-screen" class="hidden text-center bg-slate-800 p-8 rounded-xl shadow-2xl border border-red-500/20 max-w-sm">
                        <i class="fas fa-lock text-red-500 text-3xl mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">Encrypted File</h3>
                        <p class="text-xs text-gray-400 mb-4">Enter password to View/Unlock/Edit.</p>
                        <input type="password" id="decrypt-input" class="w-full bg-slate-900 border border-slate-700 rounded p-2 mb-3 text-white text-center" placeholder="Enter Password">
                        <button onclick="tryDecrypt()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded">Unlock</button>
                        <p id="unlock-msg" class="text-xs text-red-400 mt-2 hidden">Incorrect Password</p>
                    </div>
                </div>

                <!-- Step 2: Editor Canvas -->
                <div id="step-editor" class="hidden bg-slate-900 overflow-auto py-10 relative flex-grow justify-center flex">
                    <div id="pdf-wrapper">
                        <canvas id="the-canvas"></canvas>
                        <canvas id="draw-layer"></canvas>
                        <div id="text-layer"></div>
                    </div>
                </div>

            </section>

        </main>
        
        <footer class="glass-header text-center py-4 text-xs text-gray-500 z-50">APNA ADDA &copy; 2025</footer>

    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAaY6wBjg4ooOqg841Dr5Nd2bZmlDIzJYU",
            authDomain: "namaste-2bfcc.firebaseapp.com",
            databaseURL: "https://namaste-2bfcc-default-rtdb.firebaseio.com",
            projectId: "namaste-2bfcc",
            storageBucket: "namaste-2bfcc.firebasestorage.app",
            messagingSenderId: "721784358614",
            appId: "1:721784358614:web:686a564d8e965694296b77"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // --- 2. GLOBAL STATE ---
        const ST = {
            user: null,
            tool: '', // view, edit, protect, unlock
            buffer: null,
            filename: '',
            pdf: null,
            pageNum: 1,
            numPages: 0,
            scale: 1.5,
            
            // Password state for Encrypted files
            filePassword: null, 

            // Edit Data
            drawings: {}, // page -> dataUrl
            texts: {}, // page -> arr of obj
            mode: 'view', // view, pen, text
            isDraw: false,
            dlPending: false
        };

        // --- 3. INITIALIZATION & NAV ---
        window.onload = () => {
            setTimeout(() => { document.getElementById('loader').classList.add('hidden'); document.getElementById('app').classList.remove('hidden'); }, 1500);
        }

        function goHome() {
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('work-view').classList.add('hidden');
            resetST();
        }

        function resetST() {
            ST.buffer=null; ST.pdf=null; ST.filePassword=null; ST.drawings={}; ST.texts={};
            document.getElementById('file-in').value='';
            document.getElementById('step-upload').classList.remove('hidden');
            document.getElementById('drop-zone').classList.remove('hidden');
            document.getElementById('lock-screen').classList.add('hidden');
            document.getElementById('step-editor').classList.add('hidden');
        }

        function selectTool(toolName) {
            ST.tool = toolName;
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('work-view').classList.remove('hidden');
            document.getElementById('work-view').classList.remove('hidden');
            document.getElementById('work-view').style.display = 'flex'; // Ensure flex layout

            const labels = {view:'View', edit:'Edit', protect:'Protect', unlock:'Unlock'};
            document.getElementById('tool-title').textContent = labels[toolName] + ' PDF';

            // Show controls
            document.getElementById('controls-edit').classList.add('hidden');
            document.getElementById('controls-protect').classList.add('hidden');
            if(toolName==='edit') document.getElementById('controls-edit').classList.remove('hidden');
            if(toolName==='protect') document.getElementById('controls-protect').classList.remove('hidden');
        }

        // --- 4. AUTH ---
        auth.onAuthStateChanged(user => {
            ST.user = user;
            if(user) {
                document.getElementById('auth-btn').textContent = "LOGOUT";
                document.getElementById('auth-btn').onclick = () => auth.signOut();
                document.getElementById('u-name').textContent = user.email.split('@')[0];
                document.getElementById('u-name').classList.remove('hidden');
                
                if(ST.dlPending) { closeModal(); ST.dlPending=false; triggerDownload(); }
            } else {
                document.getElementById('auth-btn').textContent = "LOGIN";
                document.getElementById('auth-btn').onclick = openModal;
                document.getElementById('u-name').classList.add('hidden');
            }
        });

        function openModal() { document.getElementById('auth-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('auth-modal').classList.add('hidden'); document.getElementById('login-error').textContent=''; }

        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            try {
                await auth.signInWithEmailAndPassword(document.getElementById('u-email').value, document.getElementById('u-pass').value);
                closeModal();
            } catch(e) {
                if(e.code==='auth/user-not-found') {
                    try { await auth.createUserWithEmailAndPassword(document.getElementById('u-email').value, document.getElementById('u-pass').value); closeModal(); }
                    catch(e2) { document.getElementById('login-error').textContent=e2.message; }
                } else document.getElementById('login-error').textContent=e.message;
            }
        }

        // --- 5. FILE HANDLING ---
        document.getElementById('file-in').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            ST.filename = file.name;
            ST.buffer = await file.arrayBuffer();
            attemptLoad();
        };

        async function attemptLoad(password = null) {
            try {
                // PDF.js uses null for no password, or a string
                const loading = pdfjsLib.getDocument({ data: ST.buffer, password: password });
                ST.pdf = await loading.promise;
                
                // If success:
                ST.filePassword = password; // Save valid password
                ST.numPages = ST.pdf.numPages;
                ST.pageNum = 1;

                document.getElementById('step-upload').classList.add('hidden');
                document.getElementById('step-editor').classList.remove('hidden');
                
                // Auto Alert for "Unlock" tool usage if file was not actually locked
                if(ST.tool === 'unlock' && !password) {
                   // File was openable without password
                   // Just let user proceed to download
                }

                renderPage();

            } catch (err) {
                if (err.name === 'PasswordException') {
                    document.getElementById('drop-zone').classList.add('hidden');
                    document.getElementById('lock-screen').classList.remove('hidden');
                    document.getElementById('unlock-msg').classList.add('hidden');
                } else {
                    alert('File Error: '+err.message);
                }
            }
        }

        function tryDecrypt() {
            const pwd = document.getElementById('decrypt-input').value;
            if(!pwd) return;
            attemptLoad(pwd);
        }

        // --- 6. RENDERER ---
        async function renderPage() {
            document.getElementById('pg-num').textContent = `${ST.pageNum}/${ST.numPages}`;
            
            const page = await ST.pdf.getPage(ST.pageNum);
            const viewport = page.getViewport({ scale: ST.scale });
            
            const cvs = document.getElementById('the-canvas');
            const ctx = cvs.getContext('2d');
            const wrap = document.getElementById('pdf-wrapper');
            const dLay = document.getElementById('draw-layer');
            const tLay = document.getElementById('text-layer');

            // Set Dimentions
            cvs.width = viewport.width; cvs.height = viewport.height;
            dLay.width = viewport.width; dLay.height = viewport.height;
            wrap.style.width = viewport.width + 'px'; wrap.style.height = viewport.height + 'px';

            await page.render({ canvasContext: ctx, viewport }).promise;

            // Load Edit Layers
            const dCtx = dLay.getContext('2d');
            dCtx.clearRect(0,0,dLay.width,dLay.height);
            if(ST.drawings[ST.pageNum]) {
                const img = new Image();
                img.onload = () => dCtx.drawImage(img, 0, 0);
                img.src = ST.drawings[ST.pageNum];
            }

            tLay.innerHTML = '';
            if(ST.texts[ST.pageNum]) {
                ST.texts[ST.pageNum].forEach(t => renderTextDOM(t));
            }
        }

        function changePage(delta) {
            saveState(); // Save current page before switch
            const next = ST.pageNum + delta;
            if(next > 0 && next <= ST.numPages) {
                ST.pageNum = next;
                renderPage();
            }
        }

        // --- 7. EDITING ---
        const dLayer = document.getElementById('draw-layer');
        const tLayer = document.getElementById('text-layer');
        
        function setMode(m) {
            ST.mode = m;
            document.getElementById('btn-pen').classList.toggle('text-blue-500', m==='pen');
            document.getElementById('btn-text').classList.toggle('text-blue-500', m==='text');
            dLayer.style.pointerEvents = m==='pen' ? 'auto':'none';
            tLayer.style.pointerEvents = m==='text' ? 'auto':'none';
        }

        function getCoord(e) {
            const r = dLayer.getBoundingClientRect();
            return { x: e.clientX - r.left, y: e.clientY - r.top };
        }

        // Pen
        dLayer.onpointerdown = (e) => {
            if(ST.mode !== 'pen') return;
            ST.isDraw = true;
            const ctx = dLayer.getContext('2d');
            const p = getCoord(e);
            ctx.beginPath(); ctx.moveTo(p.x, p.y);
            ctx.strokeStyle = document.getElementById('pen-color').value;
            ctx.lineWidth = 4; ctx.lineCap='round';
            dLayer.setPointerCapture(e.pointerId);
        }
        dLayer.onpointermove = (e) => {
            if(!ST.isDraw) return;
            const ctx = dLayer.getContext('2d');
            const p = getCoord(e);
            ctx.lineTo(p.x, p.y); ctx.stroke();
        }
        dLayer.onpointerup = (e) => { ST.isDraw = false; dLayer.releasePointerCapture(e.pointerId); }

        // Text
        tLayer.onclick = (e) => {
            if(ST.mode !== 'text' || e.target.classList.contains('draggable-text')) return;
            const text = prompt("Enter text:");
            if(!text) return;
            const p = getCoord(e);
            const obj = { text, x: p.x, y: p.y, color: document.getElementById('pen-color').value };
            renderTextDOM(obj);
        }

        function renderTextDOM(obj) {
            const d = document.createElement('div');
            d.className = 'draggable-text';
            d.textContent = obj.text;
            d.style.left = obj.x+'px'; d.style.top = obj.y+'px';
            d.style.color = obj.color; d.style.fontSize = '20px';

            const del = document.createElement('div'); del.className='del-btn'; del.innerHTML='×';
            del.onclick=(e)=>{ e.stopPropagation(); d.remove(); };
            d.appendChild(del);

            d.onmousedown = (e) => {
                if(ST.mode!=='text') return;
                let sx=e.clientX, sy=e.clientY, ol=d.offsetLeft, ot=d.offsetTop;
                window.onmousemove = (mv) => { d.style.left=(ol+mv.clientX-sx)+'px'; d.style.top=(ot+mv.clientY-sy)+'px'; }
                window.onmouseup = () => window.onmousemove=null;
            }
            tLayer.appendChild(d);
        }

        function saveState() {
            if(ST.tool !== 'edit') return;
            // Draw
            ST.drawings[ST.pageNum] = dLayer.toDataURL();
            // Text
            const arr = [];
            tLayer.querySelectorAll('.draggable-text').forEach(el => {
                arr.push({ 
                    text: el.textContent.replace('×',''), 
                    x: parseInt(el.style.left), y: parseInt(el.style.top), 
                    color: el.style.color 
                });
            });
            ST.texts[ST.pageNum] = arr;
        }

        function clearCurrentEdits() {
            dLayer.getContext('2d').clearRect(0,0,dLayer.width,dLayer.height);
            tLayer.innerHTML='';
        }

        // --- 8. DOWNLOAD ENGINE (FIXED) ---
        async function triggerDownload() {
            if(!ST.user) { ST.dlPending=true; openModal(); return; }
            saveState(); // Ensure current page changes are saved
            
            // Show processing
            const oldTxt = event.target.textContent;
            event.target.textContent = "Processing...";
            
            try {
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                
                // 1. Load Document (With password if existing)
                let pdfDoc;
                if(ST.filePassword) {
                    pdfDoc = await PDFDocument.load(ST.buffer, { password: ST.filePassword });
                } else {
                    pdfDoc = await PDFDocument.load(ST.buffer);
                }

                // 2. Embed Essentials
                const helvetica = await pdfDoc.embedFont(StandardFonts.Helvetica);

                // 3. Apply Edits Loop
                if(ST.tool === 'edit') {
                    const pages = pdfDoc.getPages();
                    for(let i=0; i<pages.length; i++) {
                        const pageNum = i+1;
                        if(!ST.drawings[pageNum] && !ST.texts[pageNum]) continue;

                        const page = pages[i];
                        const { width, height } = page.getSize();
                        
                        // Apply Drawings
                        if(ST.drawings[pageNum]) {
                            const img = await pdfDoc.embedPng(ST.drawings[pageNum]);
                            page.drawImage(img, { x: 0, y: 0, width: width, height: height });
                        }

                        // Apply Texts
                        if(ST.texts[pageNum]) {
                            // Viewport reference
                            const viewportW = document.getElementById('the-canvas').width || width * 1.5; 
                            const viewportH = document.getElementById('the-canvas').height || height * 1.5;
                            const scaleX = width / viewportW; 
                            const scaleY = height / viewportH;

                            ST.texts[pageNum].forEach(t => {
                                // Parse color (Hex string like rgb(r,g,b) or #hex)
                                // Simplified to black if parser fails, else standard PDFLib rgb
                                
                                // Hex to RGB helper
                                let r=0,g=0,b=0;
                                if(t.color.startsWith('#')) {
                                    const bigint = parseInt(t.color.substring(1), 16);
                                    r = ((bigint >> 16) & 255)/255;
                                    g = ((bigint >> 8) & 255)/255;
                                    b = (bigint & 255)/255;
                                }

                                page.drawText(t.text, {
                                    x: t.x * scaleX,
                                    y: height - (t.y * scaleY) - (20 * scaleY), // adjust for baseline
                                    size: 20 * scaleX,
                                    font: helvetica,
                                    color: rgb(r, g, b)
                                });
                            });
                        }
                    }
                }

                // 4. Apply New Protection (Tool: Protect)
                if(ST.tool === 'protect') {
                    const newPwd = document.getElementById('protect-pwd').value;
                    if(newPwd) {
                        pdfDoc.encrypt({ userPassword: newPwd, ownerPassword: newPwd, permissions: {printing:'highResolution', modifying:false}});
                    }
                }
                
                // 5. UNLOCK: By saving without encryption params, PDFLib automatically decrypts it.
                // No extra code needed.

                // 6. Generate Blob & Native Download
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = ST.filename.replace('.pdf', '') + 'apnaadda.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch(e) {
                console.error(e);
                alert("Download Error: " + e.message + "\nCheck console for details.");
            } finally {
                event.target.textContent = oldTxt;
            }
        }
    </script>
</body>
</html>
